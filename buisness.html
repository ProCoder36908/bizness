<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Ensure viewport meta tag is present -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Empire Builder</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Reset default styles from provided CSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Html/Body styles from provided CSS, combined with existing */
        html, body {
            width: 100%;
            /* keep existing min-height */
            min-height: 100vh;
            /* Add height, overflow-x hidden from provided CSS */
            height: 100%;
            overflow-x: hidden;
            /* Keep existing font and background styles */
            font-family: 'Poppins', sans-serif;
            background: var(--background-color);
            color: var(--text-color);
            /* Existing animated background */
            background: linear-gradient(135deg, var(--background-color) 0%, #2a1a3e 50%, var(--background-color) 100%);
            background-size: 200% 200%;
            animation: gradient-animation 15s ease infinite alternate;
        }

        /* Main container style from provided CSS */
        #mainContainer {
            max-width: 1400px; /* Use the max-width of other sections */
            margin: 0 auto;
            padding: 20px;
        }

        /* Prevent stretching styles from provided CSS */
        .box, .card, .section, .glass-card, .widget { /* Added .glass-card and .widget */
            max-width: 100%;
            overflow: auto; /* Changed from overflow: hidden to auto to allow scrolling within the element if needed */
            word-wrap: break-word;
        }

        :root {
            --primary-color: #6C63FF;
            --secondary-color: #4CAF50;
            --background-color: #1a1a2e;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --text-color: #ffffff;
            --gradient-1: linear-gradient(45deg, #6C63FF, #FF6B6B);
            --gradient-2: linear-gradient(45deg, #4CAF50, #2196F3);
            --gradient-3: linear-gradient(45deg, #FFD700, #FF6B6B);

            --beginner-color: #4CAF50;
            --intermediate-color: #2196F3;
            --advanced-color: #9C27B0;

            --status-up: #4CAF50;
            --status-down: #f44336;
            --status-neutral: #FFC107;
        }

        /* Keyframes for background gradient animation */
        @keyframes gradient-animation {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }

        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
        }

        /* Keyframes for header entrance animation */
        @keyframes header-entrance {
            0% { opacity: 0; transform: translateY(-20px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
        }

        .header h1 {
            font-size: 2rem;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stats {
            display: flex;
            gap: 30px;
            align-items: center;
            flex-wrap: wrap;
        }

        .stat {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease; /* Add transition for hover effect */
        }

        /* Add hover effect for stat items */
        .stat:hover {
            transform: scale(1.05); /* Slightly enlarge on hover */
            background: rgba(255, 255, 255, 0.1); /* Slightly lighter background */
            box-shadow: 0 0 15px rgba(108, 99, 255, 0.3); /* Subtle glow effect */
        }

        .stat h3 {
            font-size: 1.2rem;
            margin-top: 5px;
        }

        /* Enhance font size and weight for stat values */
        .stat h3 span, .widget-grid-value, .mini-map-value {
            font-size: 1.3rem; /* Slightly larger font size */
            font-weight: 700; /* Bold font weight */
        }

        .progress-ring {
            position: relative;
            width: 100px;
            height: 100px;
            margin: 0 auto;
        }

        .progress-ring-circle {
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 0.3s ease;
        }

        .progress-ring-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2em;
            font-weight: bold;
        }

        .stat-icon {
            font-size: 1.5em;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            padding: 20px;
            justify-content: center;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            background: var(--gradient-1);
            border: none;
            border-radius: 25px;
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 99, 255, 0.4);
        }

        .btn:active {
            transform: translateY(0); /* Move button down */
            box-shadow: 0 2px 5px rgba(108, 99, 255, 0.6); /* Reduce shadow to look 'pressed' */
        }

        /* Style for active quick action button */
        .quick-actions .btn.active {
            background: var(--secondary-color); /* Highlight with secondary color */
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4); /* Corresponding shadow */
        }

        /* Add hover effect for quick action buttons */
        .quick-actions .btn:hover {
            transform: translateY(-3px) scale(1.02); /* Lift and slightly enlarge */
            box-shadow: 0 8px 20px rgba(108, 99, 255, 0.6), 0 0 10px var(--primary-color); /* Stronger shadow and primary color glow outline */
        }

        /* Keyframes for stat update flash */
        @keyframes stat-flash {
            0% { background-color: transparent; }
            50% { background-color: rgba(255, 255, 0, 0.3); } /* Yellowish flash */
            100% { background-color: transparent; }
        }

        /* Class to apply the flash animation */
        .stat-update-flash {
            animation: stat-flash 0.5s ease-out; /* Animation duration and timing */
        }

        .portfolio {
            display: flex;
            overflow-x: auto;
            gap: 20px;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            /* Apply entrance animation */
            animation: section-entrance 0.8s ease-out forwards;
            opacity: 0; /* Start hidden for animation */
            animation-delay: 0.5s; /* Delay after header might load */
        }

        .glass-card {
            min-width: 300px;
            flex-shrink: 0;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            /* Apply entrance animation */
            animation: section-entrance 0.8s ease-out forwards;
            opacity: 0; /* Start hidden for animation */
            animation-delay: 0.7s; /* Delay after portfolio might load */
        }

        .glass-card:hover {
            transform: translateY(-8px); /* Increase lift on hover */
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5), 0 0 20px var(--primary-color); /* Stronger, more spread shadow + primary color glow */
        }

        .glass-card h2 {
            display: flex;
            align-items: center;
            margin-bottom: 20px; /* Increased bottom margin */
            font-size: 1.4rem; /* Slightly larger font size */
            background: var(--gradient-1); /* Apply gradient background */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .section-icon {
            margin-right: 10px; /* Increased margin to separate icon */
            font-size: 1.3em; /* Slightly larger icon */
        }

        .command-center {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .widget {
            background: var(--glass-bg);
            border-radius: 10px;
            padding: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            cursor: move;
        }

        .widget:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .widget-title {
            font-size: 1.3em; /* Slightly larger font size */
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px; /* Increased gap to separate icon */
            background: var(--gradient-1); /* Apply gradient background */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .widget-controls {
            display: flex;
            gap: 8px;
        }

        .widget-control-btn {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            padding: 4px;
            opacity: 0.7;
            transition: opacity 0.3s ease; /* Add transition for smooth hover */
        }

        .widget-control-btn:hover {
            opacity: 1; /* Full opacity on hover */
            transform: scale(1.1); /* Slightly enlarge icon */
            transition: all 0.2s ease-in-out; /* Smooth transition for scale and opacity */
        }

        .widget-content {
            max-height: 500px; /* Set a max-height for expanded state */
            overflow-y: auto;
            transition: max-height 0.5s ease-in-out; /* Add transition for smooth collapse/expand */
        }

        .widget-content.collapsed {
            max-height: 0;
            overflow: hidden; /* Hide overflow when collapsed */
        }

        .widget-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
        }

        .widget-grid-item {
            background: rgba(255, 255, 255, 0.08); /* Slightly more prominent background */
            padding: 15px;
            border-radius: 8px; /* More rounded corners */
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1); /* Add a subtle border */
            transition: all 0.2s ease-in-out; /* Add transition for hover */
        }

        .widget-grid-value {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--primary-color);
        }

        .widget-grid-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }

        .mini-map {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            padding: 10px;
        }

        .mini-map-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1); /* Add a subtle border */
        }

        .mini-map-value {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--primary-color);
        }

        .mini-map-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }

        .list-item {
            padding: 12px; /* Slightly more padding */
            margin: 8px 0; /* Slightly more vertical margin */
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            border-left: 4px solid var(--primary-color);
        }

        /* Hover effect for list items */
        .list-item:hover {
            background: rgba(255, 255, 255, 0.1); /* Slightly lighter background on hover */
            border-left-color: var(--secondary-color); /* Change border color on hover */
        }

        .portfolio-item {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: stretch;
            padding: 15px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .portfolio-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .stock-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .stock-price {
            font-size: 1.2em;
            font-weight: 600;
        }

        .stock-change {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
        }

        .stock-change.positive {
            background: rgba(76, 175, 80, 0.2);
            color: var(--status-up);
        }

        .stock-change.negative {
            background: rgba(244, 67, 54, 0.2);
            color: var(--status-down);
        }

        .stock-change.neutral {
            background: rgba(255, 193, 7, 0.2);
            color: var(--status-neutral);
        }

        .stock-chart {
            width: 100%;
            height: 200px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 10px;
        }

        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            justify-content: center; /* Center content vertically */
            align-items: center; /* Center content horizontally */
            opacity: 0; /* Start invisible for fade-in */
            transition: opacity 0.3s ease-in-out; /* Fade transition */
        }

        .modal.show {
            display: flex; /* Use flex to center content when shown */
            opacity: 1; /* Fade in to visible */
        }

        .modal-content {
            background: var(--background-color);
            margin: 0; /* Remove auto margin for flex centering */
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transform: scale(0.95); /* Start slightly smaller for scale-in */
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; /* Transition for scale and opacity */
            opacity: 0; /* Start invisible for fade-in */
        }

        .modal.show .modal-content {
            transform: scale(1); /* Scale to normal size */
            opacity: 1; /* Fade in */
        }

        /* Keyframes for staggered fade-in animation */
        @keyframes staggered-fade-in {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        /* Apply staggered fade-in to direct children of modal content when animated */
        #modalContent.animate-modal-content > * {
            opacity: 0; /* Start invisible */
            animation: staggered-fade-in 0.5s ease-out forwards;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease; /* Smooth transition for color change */
        }

        .close:hover {
            color: var(--primary-color); /* Change color on hover */
            transform: rotate(90deg); /* Rotate icon on hover */
        }

        .tier-badge {
            display: inline-block;
            padding: 6px 10px; /* Increased padding */
            border-radius: 15px; /* More rounded corners */
            font-size: 0.85em; /* Slightly larger font size */
            font-weight: 600; /* Ensure sufficient weight */
            margin-left: 8px;
            color: white;
            text-transform: uppercase; /* Uppercase text for a label look */
            letter-spacing: 0.5px; /* Add slight letter spacing */
        }

        .tier-beginner { 
            background-color: var(--beginner-color); 
        }

        .tier-intermediate { 
            background-color: var(--intermediate-color); 
        }

        .tier-advanced { 
            background-color: var(--advanced-color); 
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 20px;
            }

            .stats {
                justify-content: center;
            }

            .quick-actions {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .portfolio {
                grid-template-columns: 1fr;
            }

            .command-center {
                grid-template-columns: 1fr;
            }
        }

        /* Add fade-in transition for list items */
        .list-item, .portfolio-item, .widget-grid-item, .mini-map-item, .owned-asset-item {
            opacity: 0; /* Start invisible */
            animation: fadeIn 0.5s ease-out forwards; /* Apply fade-in animation */
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        .owned-asset-item {
            background: rgba(255, 255, 255, 0.1); /* Slightly more prominent background */
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px; /* Increased space between owned items */
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            border: 1px solid rgba(255, 255, 255, 0.15); /* Slightly more prominent border */
            transition: all 0.3s ease; /* Add transition for potential future hover effects */
        }

        .owned-asset-item:hover {
             transform: translateY(-3px);
             box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .owned-asset-item div:first-child {
            flex-grow: 1;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .owned-asset-item div:first-child {
            flex-grow: 1;
            margin-right: 10px; /* Space between info and button */
        }

        .owned-asset-item .btn.cash-in-btn {
            background: var(--status-down); /* Red background for cash in button */
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: background 0.3s ease;
            margin-top: 0; /* Remove top margin when not wrapped */
        }

        .owned-asset-item .btn.cash-in-btn:hover {
            background: #f03a2b; /* Slightly darker red on hover */
        }

        /* Adjusting portfolio item to not have flex properties when containing owned assets */
        .portfolio-item.owned-asset-item {
            flex-direction: row; /* Override the column direction from .portfolio-item */
        }

        /* Scroll to Top Button Styles */
        #scrollToTopBtn {
            display: none; /* Hidden by default */
            position: fixed; /* Fixed position */
            bottom: 20px; /* Place at the bottom */
            right: 20px; /* Place at the right */
            z-index: 99; /* Ensure it's above other content */
            border: none; /* Remove borders */
            outline: none; /* Remove outline */
            background-color: var(--primary-color); /* Background color */
            color: white; /* Text color */
            cursor: pointer; /* Add a mouse pointer on hover */
            padding: 15px; /* Some padding */
            border-radius: 10px; /* Rounded corners */
            font-size: 18px; /* Increase font size */
            transition: opacity 0.3s ease-in-out; /* Smooth transition for opacity */
            opacity: 0.8; /* Slightly transparent when not hovered */
        }

        #scrollToTopBtn:hover {
            opacity: 1; /* Full opacity on hover */
        }

        /* Custom Scrollbar Styles */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05); /* Semi-transparent track */
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-color); /* Use primary color for the thumb */
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.05); /* Add border to match track */
        }

        /* Hover effect for widget grid and mini-map items */
        .widget-grid-item:hover, .mini-map-item:hover {
            background: rgba(255, 255, 255, 0.1); /* Slightly lighter background */
            transform: scale(1.03); /* Slightly enlarge */
            transition: all 0.2s ease-in-out; /* Smooth transition */
            cursor: pointer; /* Indicate clickability (if applicable) */
        }

        /* Keyframes for section entrance animation */
        @keyframes section-entrance {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        /* Keyframes for icon pulse animation */
        @keyframes icon-pulse {
            0% { transform: scale(0.9); opacity: 0.6; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Apply pulse animation to icons */
        .fas, .stat-icon, .section-icon, .widget-title i {
            animation: icon-pulse 0.6s ease-out forwards; /* Apply the animation */
            opacity: 0; /* Start hidden for animation */
            /* Add delay for staggered effect (optional, adjust as needed) */
             animation-delay: 0.1s;
        }

        /* Keyframes for stat icon update animation */
        @keyframes stat-icon-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Class to apply stat icon animation */
        .stat-icon-update {
            animation: stat-icon-pop 0.4s ease-out; /* Animation duration and timing */
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 20px;
            }

            .stats {
                justify-content: center;
            }

            .quick-actions {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .portfolio {
                grid-template-columns: 1fr;
            }

            .command-center {
                grid-template-columns: 1fr;
            }
        }

        /* Add new CSS styles for portfolio card dropdowns */
        .glass-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px; /* Adjust spacing */
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer; /* Indicate clickability */
            transition: border-color 0.3s ease; /* Smooth transition for border */
        }

        .glass-card .card-header:hover {
            border-bottom-color: var(--primary-color); /* Highlight border on hover */
        }

        .glass-card .card-toggle-icon {
            font-size: 1.2em; /* Slightly larger icon */
            transition: transform 0.3s ease; /* Smooth rotation */
        }

        .glass-card .card-content {
            max-height: 500px; /* Set max-height for expanded state */
            overflow-y: auto;
            transition: max-height 0.5s ease-in-out; /* Smooth collapse/expand */
        }

        .glass-card .card-content.collapsed {
            max-height: 0;
            overflow: hidden;
        }

        /* Add fade-in transition for list items */
        /* Added .card-content > * to apply animation to direct children of collapsed content */
        .list-item, .portfolio-item, .widget-grid-item, .mini-map-item, .owned-asset-item, .card-content > * {
            opacity: 0; /* Start invisible */
            animation: fadeIn 0.5s ease-out forwards; /* Apply fade-in animation */
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        #settingsToggle {
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 10px 15px;
          border: none;
          border-radius: 50%;
          background-color: var(--primary-color);
          color: white;
          font-size: 18px;
          cursor: pointer;
          z-index: 9999;
        }

        #settingsPanel {
          position: fixed;
          top: 70px;
          right: 20px;
          background: rgba(0, 0, 0, 0.85);
          padding: 15px;
          border-radius: 10px;
          color: white;
          z-index: 9999;
          font-family: 'Poppins', sans-serif;
        }
        #settingsPanel label, #settingsPanel button {
          margin-top: 10px;
          display: block;
        }
    </style>
</head>
<body>
    <div id="mainContainer">
        <div id="particles-js"></div>
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> Business Empire Builder</h1>
            <div class="stats">
            <div class="stat">
                    <i class="fas fa-wallet stat-icon"></i>
                    <h3>Cash: $<span id="cash">1000</span></h3>
            </div>
            <div class="stat">
                    <div class="progress-ring">
                        <svg width="100" height="100">
                            <circle class="progress-ring-circle-bg" cx="50" cy="50" r="45" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="5"/>
                            <circle class="progress-ring-circle" cx="50" cy="50" r="45" fill="none" stroke="var(--primary-color)" stroke-width="5" stroke-dasharray="283" stroke-dashoffset="0"/>
                        </svg>
                        <div class="progress-ring-text">
                            <i class="fas fa-bolt"></i>
                            <span id="energy">100</span>%
                </div>
                    </div>
            </div>
            <div class="stat">
                    <i class="fas fa-chart-pie stat-icon"></i>
                    <h3>Net Worth: $<span id="netWorth">1000</span></h3>
                </div>
                <!-- Settings Button -->
                <div class="stat">
                    <button class="btn" onclick="showSettings()" title="Game Settings" style="padding: 10px 15px;"><i class="fas fa-cog"></i></button>
                </div>
            </div>
        </div>

        <div class="quick-actions">
            <button class="btn" onclick="showHustles(this)" title="Explore available hustles to earn quick cash"><i class="fas fa-briefcase"></i> Hustles</button>
            <button class="btn" onclick="showStockMarket(this)" title="Trade stocks to grow your wealth"><i class="fas fa-chart-line"></i> Stock Market</button>
            <button class="btn" onclick="showRealEstate(this)" title="Invest in properties for passive income"><i class="fas fa-home"></i> Real Estate</button>
            <button class="btn" onclick="showBusinesses(this)" title="Start or buy businesses for daily profits"><i class="fas fa-building"></i> Businesses</button>
            <button class="btn" onclick="showBonds(this)" title="Purchase bonds for steady returns"><i class="fas fa-file-invoice-dollar"></i> Bonds</button>
            <button class="btn" onclick="showSideGigs(this)" title="Find and work on freelance gigs"><i class="fas fa-tasks"></i> Side Gigs</button>
            <button class="btn" onclick="showStarterBusinesses(this)" title="Invest in small businesses to get started"><i class="fas fa-store"></i> Starter Businesses</button>
            <button class="btn" onclick="showSittingServices(this)" title="Offer various sitting services for daily pay"><i class="fas fa-paw"></i> Sitting Services</button>
            <button class="btn" onclick="showCryptoFaucets(this)" title="Claim small amounts of cryptocurrency"><i class="fas fa-coins"></i> Crypto Faucets</button>
            <button class="btn" onclick="showMentors(this)" title="Hire mentors for tips and bonuses"><i class="fas fa-user-tie"></i> Mentors</button>
            <button class="btn" onclick="showAchievements(this)" title="View your completed and pending achievements"><i class="fas fa-trophy"></i> Achievements</button>
            <button class="btn" onclick="showDailyChallenges(this)" title="See and track your daily goals"><i class="fas fa-calendar-check"></i> Daily Challenges</button>
            <button class="btn" onclick="showTutorial()" title="Learn how to play the game"><i class="fas fa-question-circle"></i> Tutorial</button>
            <button class="btn" onclick="showUpgrades(this)" title="Improve your abilities and investments"><i class="fas fa-arrow-alt-circle-up"></i> Upgrades</button>
            <button class="btn" onclick="collapseAllPortfolioCards()" title="Collapse all portfolio sections"><i class="fas fa-compress-alt"></i> Collapse All</button>
            <button class="btn" onclick="expandAllPortfolioCards()" title="Expand all portfolio sections"><i class="fas fa-expand-alt"></i> Expand All</button>
        </div>

        <div class="portfolio">
            <div class="glass-card" id="stocks-card">
                <div class="card-header" onclick="togglePortfolioCard('stocks-card')">
                    <h2><i class="fas fa-chart-line section-icon"></i> Stocks</h2>
                    <i class="fas fa-chevron-up card-toggle-icon"></i>
                </div>
                <div class="card-content">
                    <p>Value: $<span id="stockValue">0</span></p>
                    <div id="stockDetails"></div>
                </div>
            </div>
            <div class="glass-card" id="real-estate-card">
                <div class="card-header" onclick="togglePortfolioCard('real-estate-card')">
                    <h2><i class="fas fa-home section-icon"></i> Real Estate</h2>
                    <i class="fas fa-chevron-up card-toggle-icon"></i>
                </div>
                <div class="card-content">
                    <p>Value: $<span id="realEstateValue">0</span></p>
                    <div id="realEstateDetails"></div>
                </div>
            </div>
            <div class="glass-card" id="businesses-card">
                <div class="card-header" onclick="togglePortfolioCard('businesses-card')">
                    <h2><i class="fas fa-building section-icon"></i> Businesses</h2>
                    <i class="fas fa-chevron-up card-toggle-icon"></i>
                </div>
                <div class="card-content">
                    <p>Value: $<span id="businessValue">0</span></p>
                    <div id="businessDetails"></div>
                </div>
            </div>
            <div class="glass-card" id="bonds-card">
                <div class="card-header" onclick="togglePortfolioCard('bonds-card')">
                    <h2><i class="fas fa-file-invoice-dollar section-icon"></i> Bonds</h2>
                    <i class="fas fa-chevron-up card-toggle-icon"></i>
                </div>
                <div class="card-content">
                    <p>Value: $<span id="bondValue">0</span></p>
                    <div id="bondDetails"></div>
                </div>
            </div>
            <div class="glass-card" id="side-gigs-card">
                 <div class="card-header" onclick="togglePortfolioCard('side-gigs-card')">
                     <h2><i class="fas fa-tasks section-icon"></i> Side Gigs</h2>
                     <i class="fas fa-chevron-up card-toggle-icon"></i>
                </div>
                <div class="card-content">
                     <p>Value: $<span id="sideGigValue">0</span></p>
                     <div id="sideGigDetails"></div>
                </div>
            </div>
            <div class="glass-card" id="starter-businesses-card">
                 <div class="card-header" onclick="togglePortfolioCard('starter-businesses-card')">
                     <h2><i class="fas fa-store section-icon"></i> Starter Businesses</h2>
                     <i class="fas fa-chevron-up card-toggle-icon"></i>
                 </div>
                 <div class="card-content">
                     <p>Value: $<span id="starterBusinessValue">0</span></p>
                     <div id="starterBusinessDetails"></div>
                 </div>
            </div>
            <div class="glass-card" id="sitting-services-card">
                 <div class="card-header" onclick="togglePortfolioCard('sitting-services-card')">
                     <h2><i class="fas fa-paw section-icon"></i> Sitting Services</h2>
                     <i class="fas fa-chevron-up card-toggle-icon"></i>
                 </div>
                 <div class="card-content">
                     <p>Value: $<span id="sittingServiceValue">0</span></p>
                     <div id="sittingServiceDetails"></div>
                </div>
            </div>
        </div>

        <!-- Game Modal -->
        <div id="gameModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('gameModal')"><i class="fas fa-times"></i></span>
                <div id="modalContent"></div>
            </div>
        </div>

        <!-- Tutorial Modal -->
        <div id="tutorialModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('tutorialModal')"><i class="fas fa-times"></i></span>
                <div id="tutorialContent">
                    <h2><i class="fas fa-question-circle"></i> Game Tutorial</h2>
                    <p>Welcome to Business Empire Builder! Here's a quick guide to get you started:</p>
                    <h3>Stats:</h3>
                    <ul>
                        <li><strong>Cash:</strong> Your money. Earn more through hustles and investments.</li>
                        <li><strong>Energy:</strong> Required for performing hustles. Recovers over time.</li>
                        <li><strong>Net Worth:</strong> Total value of your cash and assets.</li>
                    </ul>
                    <h3>Quick Actions:</h3>
                    <p>Use these buttons to access different parts of the game like the Stock Market, Real Estate, Hustles, etc.</p>
                    <h3>Portfolio:</h3>
                    <p>Track your investments and assets here.</p>
                    <h3>Command Center:</h3>
                    <p>See key stats and information at a glance.</p>
                    <p>Explore the different sections and make smart investments to build your business empire!</p>
                </div>
            </div>
        </div>

        <div class="command-center">
            <!-- Key Stats Widget -->
            <div class="widget" id="key-stats-widget">
                <div class="widget-header">
                    <div class="widget-title">
                        <i class="fas fa-chart-line"></i>
                        Key Stats
            </div>
                    <div class="widget-controls">
                        <button class="widget-control-btn" onclick="toggleWidget('key-stats-widget')">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                        <button class="widget-control-btn" onclick="showWidgetSettings('key-stats-widget')">
                            <i class="fas fa-cog"></i>
                        </button>
        </div>
            </div>
                <div class="widget-content">
                    <div class="widget-grid">
                        <div class="widget-grid-item">
                            <div class="widget-grid-value" id="cash-value">$1,000</div>
                            <div class="widget-grid-label">Cash</div>
        </div>
                        <div class="widget-grid-item">
                            <div class="widget-grid-value" id="energy-value">100%</div>
                            <div class="widget-grid-label">Energy</div>
        </div>
                        <div class="widget-grid-item">
                            <div class="widget-grid-value" id="net-worth-value">$1,000</div>
                            <div class="widget-grid-label">Net Worth</div>
    </div>
                    </div>
            </div>
        </div>

            <!-- Investment Overview Widget -->
            <div class="widget" id="investment-overview-widget">
                <div class="widget-header">
                    <div class="widget-title">
                        <i class="fas fa-map"></i>
                        Investment Overview
            </div>
                    <div class="widget-controls">
                        <button class="widget-control-btn" onclick="toggleWidget('investment-overview-widget')">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                        <button class="widget-control-btn" onclick="showWidgetSettings('investment-overview-widget')">
                            <i class="fas fa-cog"></i>
                        </button>
    </div>
                </div>
                <div class="widget-content">
                    <div class="mini-map">
                        <div class="mini-map-item">
                            <div class="mini-map-value" id="stocks-overview">$0</div>
                            <div class="mini-map-label">Stocks</div>
    </div>
                        <div class="mini-map-item">
                            <div class="mini-map-value" id="real-estate-overview">$0</div>
                            <div class="mini-map-label">Real Estate</div>
                        </div>
                        <div class="mini-map-item">
                            <div class="mini-map-value" id="businesses-overview">$0</div>
                            <div class="mini-map-label">Businesses</div>
                        </div>
                        <div class="mini-map-item">
                            <div class="mini-map-value" id="bonds-overview">$0</div>
                            <div class="mini-map-label">Bonds</div>
                        </div>
                    </div>
            </div>
        </div>

            <!-- Daily Income Widget -->
            <div class="widget" id="daily-income-widget">
                <div class="widget-header">
                    <div class="widget-title">
                        <i class="fas fa-coins"></i>
                        Daily Income
                    </div>
                    <div class="widget-controls">
                        <button class="widget-control-btn" onclick="toggleWidget('daily-income-widget')">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                        <button class="widget-control-btn" onclick="showWidgetSettings('daily-income-widget')">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                </div>
                <div class="widget-content">
                    <div class="widget-grid">
                        <div class="widget-grid-item">
                            <div class="widget-grid-value" id="business-income">$0</div>
                            <div class="widget-grid-label">Business Income</div>
                        </div>
                        <div class="widget-grid-item">
                            <div class="widget-grid-value" id="property-income">$0</div>
                            <div class="widget-grid-label">Property Income</div>
                        </div>
                        <div class="widget-grid-item">
                            <div class="widget-grid-value" id="bond-income">$0</div>
                            <div class="widget-grid-label">Bond Income</div>
                        </div>
                    </div>
            </div>
        </div>

            <!-- Active Opportunities Widget -->
            <div class="widget" id="opportunities-widget">
                <div class="widget-header">
                    <div class="widget-title">
                        <i class="fas fa-star"></i>
                        Active Opportunities
                    </div>
                    <div class="widget-controls">
                        <button class="widget-control-btn" onclick="toggleWidget('opportunities-widget')">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                        <button class="widget-control-btn" onclick="showWidgetSettings('opportunities-widget')">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                </div>
                <div class="widget-content">
                    <div id="active-opportunities-list"></div>
                </div>
            </div>
        </div>

        <script>
            // Add placeholder function for settings
            function showSettings() {
                alert('Settings - Feature coming soon!'); // Placeholder for settings functionality
                // You can replace this with code to open a settings modal or page
            }

            // Add placeholder function for upgrades
            function showUpgrades() {
                 alert('Upgrades - Feature coming soon!'); // Placeholder for upgrades functionality
                // You can replace this with code to open an upgrades modal or page
            }

            // Add JavaScript function to toggle portfolio cards
            function togglePortfolioCard(cardId) {
                const card = document.getElementById(cardId);
                const content = card.querySelector('.card-content');
                const icon = card.querySelector('.card-toggle-icon');

                if (content.classList.contains('collapsed')) {
                    content.classList.remove('collapsed');
                    if (icon) icon.className = 'fas fa-chevron-up card-toggle-icon';
                } else {
                    content.classList.add('collapsed');
                    if (icon) icon.className = 'fas fa-chevron-down card-toggle-icon';
                }
            }

            // Add JavaScript functions to collapse and expand all portfolio cards
            function collapseAllPortfolioCards() {
                const portfolioCards = document.querySelectorAll('.portfolio .glass-card');
                portfolioCards.forEach(card => {
                    const content = card.querySelector('.card-content');
                    const icon = card.querySelector('.card-toggle-icon');
                    if (content && icon) {
                        content.classList.add('collapsed');
                        icon.className = 'fas fa-chevron-down card-toggle-icon';
                    }
                });
            }

            function expandAllPortfolioCards() {
                const portfolioCards = document.querySelectorAll('.portfolio .glass-card');
                portfolioCards.forEach(card => {
                    const content = card.querySelector('.card-content');
                    const icon = card.querySelector('.card-toggle-icon');
                    if (content && icon) {
                        content.classList.remove('collapsed');
                        icon.className = 'fas fa-chevron-up card-toggle-icon';
                    }
                });
            }


            // Game State
            const gameState = {
                cash: 1000,
                energy: 100,
                day: 1,
                portfolio: {
                    stocks: {},
                    realEstate: {},
                    businesses: {},
                    bonds: {},
                    sideGigs: {},
                    starterBusinesses: {},
                    sittingServices: {},
                    crypto: {}
                },
                dailyProgress: {
                    hustle: 0,
                    stock_trades: 0,
                    businesses: 0,
                    properties: 0
                },
                achievements: {},
                currentMentor: null,
                goldenOpportunities: [],
                lastPlayedTimestamp: Date.now()
            };

            // Load game state from localStorage
            function loadGameState() {
                const savedState = localStorage.getItem('businessEmpireGame');
                if (savedState) {
                    const parsed = JSON.parse(savedState);
                    // Merge loaded state with current game state defaults
                    Object.assign(gameState, parsed);

                    // Ensure all current stocks exist in the portfolio, initialize if missing
                    stocks.forEach(stock => {
                        if (!gameState.portfolio.stocks[stock.symbol]) {
                            gameState.portfolio.stocks[stock.symbol] = 0;
                        }
                    });

                    // Calculate and apply offline earnings
                    calculateOfflineEarnings();

                    updateUI();
                }
            }

            // Save game state to localStorage
            function saveGameState() {
                gameState.lastPlayedTimestamp = Date.now(); // Update timestamp on save
                localStorage.setItem('businessEmpireGame', JSON.stringify(gameState));
            }

            // Calculate offline earnings
            function calculateOfflineEarnings() {
                const now = Date.now();
                const lastPlayed = gameState.lastPlayedTimestamp || now; // Use now if timestamp is missing
                const offlineDurationMs = now - lastPlayed;
                const offlineDurationDays = offlineDurationMs / (1000 * 60 * 60 * 24); // Convert milliseconds to days

                if (offlineDurationDays > 0) {
                    let totalOfflineIncome = 0;

                    // Calculate income from Real Estate
                    Object.values(gameState.portfolio.realEstate).forEach(property => {
                        totalOfflineIncome += property.dailyIncome * offlineDurationDays;
                    });

                    // Calculate income from Businesses
                    Object.values(gameState.portfolio.businesses).forEach(business => {
                        totalOfflineIncome += business.dailyIncome * offlineDurationDays;
                    });

                    // Calculate income from Bonds
                    Object.values(gameState.portfolio.bonds).forEach(bond => {
                        totalOfflineIncome += bond.dailyIncome * offlineDurationDays;
                    });

                    // Add other income sources here as needed (e.g., passive income from side gigs/businesses)
                    // For simplicity, hourly/daily rates for gigs/services are not included in passive offline income in this example.
                    // If you want to include them, you'd need a different logic (e.g., assuming a certain number of hours/days worked offline).

                    if (totalOfflineIncome > 0) {
                        gameState.cash += totalOfflineIncome;
                        alert(`Welcome back! You earned $${formatNumber(totalOfflineIncome)} while you were offline.`);
                        updateUI();
                    }
                }
            }

            // Game Data
            const stocks = [
                { 
                    name: 'TechCorp', 
                    symbol: 'TECH', 
                    basePrice: 150,
                    price: 150, 
                    change: 0,
                    history: [],
                    volatility: 0.02,
                    trend: 0.001, // Slight upward trend
                    lastUpdate: Date.now()
                },
                { 
                    name: 'GreenEnergy', 
                    symbol: 'GREEN', 
                    basePrice: 85,
                    price: 85, 
                    change: 0,
                    history: [],
                    volatility: 0.015,
                    trend: 0.002, // Stronger upward trend
                    lastUpdate: Date.now()
                },
                { 
                    name: 'HealthPlus', 
                    symbol: 'HLTH', 
                    basePrice: 220,
                    price: 220, 
                    change: 0,
                    history: [],
                    volatility: 0.025,
                    trend: 0.0005, // Very slight upward trend
                    lastUpdate: Date.now()
                },
                { 
                    name: 'AutoDrive', 
                    symbol: 'AUTO', 
                    basePrice: 95,
                    price: 95, 
                    change: 0,
                    history: [],
                    volatility: 0.018,
                    trend: -0.001, // Slight downward trend
                    lastUpdate: Date.now()
                },
                { 
                    name: 'McDonalds', 
                    symbol: 'MCD', 
                    basePrice: 250,
                    price: 250, 
                    change: 0,
                    history: [],
                    volatility: 0.01,
                    trend: 0.0015, // Steady upward trend
                    lastUpdate: Date.now()
                },
                { 
                    name: 'Nvidia', 
                    symbol: 'NVDA', 
                    basePrice: 900,
                    price: 900, 
                    change: 0,
                    history: [],
                    volatility: 0.03,
                    trend: 0.003, // Strong upward trend (tech growth)
                    lastUpdate: Date.now()
                },
                { 
                    name: 'AMD', 
                    symbol: 'AMD', 
                    basePrice: 180,
                    price: 180, 
                    change: 0,
                    history: [],
                    volatility: 0.028,
                    trend: 0.0025, // Solid upward trend (tech growth)
                    lastUpdate: Date.now()
                }
            ];

            const mentors = {
                WARREN: {
                    name: "Warren Buffett",
                    tips: [
                        "Buy when others are fearful, sell when others are greedy.",
                        "It's better to buy a wonderful company at a fair price than a fair company at a wonderful price.",
                        "The stock market is a device for transferring money from the impatient to the patient.",
                        "Never invest in a business you cannot understand.",
                        "Price is what you pay. Value is what you get."
                    ],
                    giftChance: 0.1,
                    giftRange: { min: 100, max: 1000 }
                },
                ELON: {
                    name: "Elon Musk",
                    tips: [
                        "The future belongs to those who believe in the beauty of their dreams.",
                        "When something is important enough, you do it even if the odds are not in your favor.",
                        "Innovation is the key to success in business.",
                        "Take risks now. Do something bold. You won't regret it.",
                        "The first step is to establish that something is possible; then probability will occur."
                    ],
                    giftChance: 0.15,
                    giftRange: { min: 200, max: 1500 }
                },
                MARK: {
                    name: "Mark Cuban",
                    tips: [
                        "It doesn't matter how many times you fail. You only have to be right once.",
                        "Work like there is someone working 24 hours a day to take it all away from you.",
                        "The best way to predict the future is to create it.",
                        "Don't start a company unless it's an obsession and something you love.",
                        "Sweat equity is the most valuable equity there is."
                    ],
                    giftChance: 0.2,
                    giftRange: { min: 300, max: 2000 }
                }
            };

            const achievements = {
                FIRST_HUSTLE: {
                    name: "First Hustle",
                    description: "Complete your first successful hustle",
                    reward: 500,
                    completed: false
                },
                FIRST_STOCK: {
                    name: "Stock Market Debut",
                    description: "Make your first stock purchase",
                    reward: 1000,
                    completed: false
                },
                NET_WORTH_5K: {
                    name: "Rising Star",
                    description: "Reach $5,000 net worth",
                    reward: 2000,
                    completed: false
                }
            };

            const dailyChallenges = [
                {
                    name: "Hustle Master",
                    description: "Complete 5 successful hustles",
                    reward: 300,
                    requirement: { type: 'hustle', count: 5 }
                },
                {
                    name: "Stock Trader",
                    description: "Make 3 stock trades",
                    reward: 400,
                    requirement: { type: 'stock_trades', count: 3 }
                },
                {
                    name: "Business Owner",
                    description: "Start 2 new businesses",
                    reward: 500,
                    requirement: { type: 'businesses', count: 2 }
                },
                {
                    name: "Real Estate Mogul",
                    description: "Purchase 2 properties",
                    reward: 600,
                    requirement: { type: 'properties', count: 2 }
                }
            ];

            // Utility Functions
            function formatNumber(num) {
                return num.toLocaleString('en-US', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                });
            }

            function calculateNetWorth() {
                let total = gameState.cash;

                // Add stock values
                Object.entries(gameState.portfolio.stocks).forEach(([symbol, shares]) => {
                    const stock = stocks.find(s => s.symbol === symbol);
                    if (stock) {
                        total += stock.price * shares;
                    }
                });

                // Add real estate values
                Object.values(gameState.portfolio.realEstate).forEach(property => {
                    total += property.value;
                });

                // Add business values
                Object.values(gameState.portfolio.businesses).forEach(business => {
                    total += business.value;
                });

                // Add bond values
                Object.values(gameState.portfolio.bonds).forEach(bond => {
                    total += bond.value;
                });

                // Add starter business values
                Object.values(gameState.portfolio.starterBusinesses).forEach(business => {
                    total += business.value;
                });

                // Add sitting service values
                Object.values(gameState.portfolio.sittingServices).forEach(service => {
                    total += service.value;
                });

                return total;
            }

            function calculateStockValue() {
                let total = 0;
                Object.entries(gameState.portfolio.stocks).forEach(([symbol, shares]) => {
                    const stock = stocks.find(s => s.symbol === symbol);
                    if (stock) {
                        total += stock.price * shares;
                    }
                });
                return total;
            }

            function calculateRealEstateValue() {
                return Object.values(gameState.portfolio.realEstate)
                    .reduce((total, property) => total + property.value, 0);
            }

            function calculateBusinessValue() {
                return Object.values(gameState.portfolio.businesses)
                    .reduce((total, business) => total + business.value, 0);
            }

            function calculateBondValue() {
                return Object.values(gameState.portfolio.bonds)
                    .reduce((total, bond) => total + bond.value, 0);
            }

            function calculateSideGigValue() {
                return Object.values(gameState.portfolio.sideGigs)
                    .reduce((total, gig) => total + (gig.hourlyRate * 160), 0);
            }

            function calculateStarterBusinessValue() {
                return Object.values(gameState.portfolio.starterBusinesses)
                    .reduce((total, business) => total + business.value, 0);
            }

            function calculateSittingServiceValue() {
                return Object.values(gameState.portfolio.sittingServices)
                    .reduce((total, service) => total + service.value, 0);
            }

            function calculateBusinessIncome() {
                return Object.values(gameState.portfolio.businesses)
                    .reduce((total, business) => total + business.dailyIncome, 0);
            }

            function calculatePropertyIncome() {
                return Object.values(gameState.portfolio.realEstate)
                    .reduce((total, property) => total + property.dailyIncome, 0);
            }

            function calculateBondIncome() {
                return Object.values(gameState.portfolio.bonds)
                    .reduce((total, bond) => total + bond.dailyIncome, 0);
            }

            // Game Mechanics Functions
            function startHustle(type, hourlyPay, energyCost) {
                if (gameState.energy >= energyCost) {
                    gameState.cash += hourlyPay;
                    gameState.energy -= energyCost;
                    gameState.dailyProgress.hustle += 1;
                    updateUI();
                    alert(`You earned $${hourlyPay} from ${type}! Energy: -${energyCost}`);
                    closeModal('gameModal');
                } else {
                    alert('Not enough energy! Rest to recover energy.');
                }
            }

            function buyStock(symbol, price) {
                if (gameState.cash >= price) {
                    gameState.cash -= price;
                    gameState.portfolio.stocks[symbol] = (gameState.portfolio.stocks[symbol] || 0) + 1;
                    gameState.dailyProgress.stock_trades += 1;
                    
                    // Store the original purchase price
                    const stock = stocks.find(s => s.symbol === symbol);
                    if (stock) {
                        stock.originalPrice = price;
                    }
                    
                    updateUI();
                    saveGameState();
                    alert(`Bought 1 share of ${symbol} for $${price.toFixed(2)}!`);
                } else {
                    alert('Not enough cash!');
                }
            }

            function buyProperty(name, price, income) {
                if (gameState.cash >= price) {
                    gameState.cash -= price;
                    gameState.portfolio.realEstate[name] = { value: price, dailyIncome: income };
                    gameState.dailyProgress.properties += 1;
                    updateUI();
                    alert(`Purchased ${name} for $${price.toLocaleString()}!`);
                    closeModal('gameModal');
                } else {
                    alert('Not enough cash!');
                }
            }

            function buyBusiness(name, price, income) {
                if (gameState.cash >= price) {
                    gameState.cash -= price;
                    gameState.portfolio.businesses[name] = { value: price, dailyIncome: income };
                    gameState.dailyProgress.businesses += 1;
                    updateUI();
                    alert(`Invested in ${name} for $${price.toLocaleString()}!`);
                    closeModal('gameModal');
                } else {
                    alert('Not enough cash!');
                }
            }

            function buyBond(name, price, income) {
                if (gameState.cash >= price) {
                    gameState.cash -= price;
                    gameState.portfolio.bonds[name] = { value: price, dailyIncome: income };
                    updateUI();
                    alert(`Purchased ${name} bond for $${price.toLocaleString()}!`);
                    closeModal('gameModal');
                } else {
                    alert('Not enough cash!');
                }
            }

            function startSideGig(name, rate) {
                gameState.portfolio.sideGigs[name] = { hourlyRate: rate };
                updateUI();
                alert(`Started ${name} side gig at $${rate}/hour!`);
                closeModal('gameModal');
            }

            function buyStarterBusiness(name, price, income) {
                if (gameState.cash >= price) {
                    gameState.cash -= price;
                    gameState.portfolio.starterBusinesses[name] = { value: price, dailyIncome: income };
                    updateUI();
                    alert(`Started ${name} for $${price.toLocaleString()}!`);
                    closeModal('gameModal');
                } else {
                    alert('Not enough cash!');
                }
            }

            function startSittingService(name, rate) {
                gameState.portfolio.sittingServices[name] = { value: rate * 30, dailyRate: rate };
                updateUI();
                alert(`Started ${name} service at $${rate}/day!`);
                closeModal('gameModal');
            }

            function claimFaucet(name, reward, currency) {
                if (gameState.energy >= 5) {
                    const cashValue = currency === 'BTC' ? reward * 45000 : currency === 'ETH' ? reward * 3000 : reward * 0.1;
                    gameState.cash += cashValue;
                    gameState.energy -= 5;
                    updateUI();
                    alert(`Claimed ${reward} ${currency} ($${cashValue.toFixed(2)}) from ${name}!`);
                } else {
                    alert('Not enough energy! Need 5 energy to claim.');
                }
            }

            function hireMentor(name, cost, benefit) {
                if (gameState.cash >= cost) {
                    gameState.cash -= cost;
                    gameState.currentMentor = { name, benefit };
                    updateUI();
                    alert(`Hired ${name} as your mentor! Benefit: ${benefit}`);
                    closeModal('gameModal');
                } else {
                    alert('Not enough cash!');
                }
            }

            // UI Functions
            function updateUI() {
                // Update basic stats
                const cashElement = document.getElementById('cash');
                const energyElement = document.getElementById('energy');
                const netWorthElement = document.getElementById('netWorth');

                const oldCash = parseInt(cashElement.textContent.replace(/[^0-9]/g, ''));
                const oldEnergy = parseInt(energyElement.textContent.replace(/[^0-9]/g, ''));
                const oldNetWorth = parseInt(netWorthElement.textContent.replace(/[^0-9]/g, ''));

                const newCash = gameState.cash;
                const newNetWorth = calculateNetWorth();
                const newEnergy = gameState.energy;

                if (newCash !== oldCash) {
                    cashElement.textContent = formatNumber(newCash);
                    cashElement.classList.add('stat-update-flash');
                    setTimeout(() => {
                        cashElement.classList.remove('stat-update-flash');
                    }, 500); // Match animation duration
                }

                if (newEnergy !== oldEnergy) {
                    energyElement.textContent = newEnergy;
                    energyElement.classList.add('stat-update-flash');
                    setTimeout(() => {
                        energyElement.classList.remove('stat-update-flash');
                    }, 500); // Match animation duration
                }

                if (newNetWorth !== oldNetWorth) {
                    netWorthElement.textContent = formatNumber(newNetWorth);
                    netWorthElement.classList.add('stat-update-flash');
                    setTimeout(() => {
                        netWorthElement.classList.remove('stat-update-flash');
                    }, 500); // Match animation duration
                }

                // Update energy progress ring
                const energyRing = document.querySelector('.progress-ring-circle');
                if (energyRing) {
                    // Check if energy has changed before updating the ring
                    const oldEnergy = parseInt(document.getElementById('energy').textContent.replace(/[^0-9]/g, ''));
                    const newEnergyValue = gameState.energy;

                    if (newEnergyValue !== oldEnergy) {
                        // Update the text value (flash animation already handled above)
                        document.getElementById('energy').textContent = newEnergyValue;

                        // Animate the progress ring
                        const circumference = 2 * Math.PI * 45;
                        const offset = circumference - (newEnergyValue / 100) * circumference;
                        // The CSS transition on stroke-dashoffset will handle the animation
                        energyRing.style.strokeDashoffset = offset;
                    }
                }

                // Update portfolio values
                document.getElementById('stockValue').textContent = formatNumber(calculateStockValue());
                document.getElementById('realEstateValue').textContent = formatNumber(calculateRealEstateValue());
                document.getElementById('businessValue').textContent = formatNumber(calculateBusinessValue());
                document.getElementById('bondValue').textContent = formatNumber(calculateBondValue());
                document.getElementById('sideGigValue').textContent = formatNumber(calculateSideGigValue());
                document.getElementById('starterBusinessValue').textContent = formatNumber(calculateStarterBusinessValue());
                document.getElementById('sittingServiceValue').textContent = formatNumber(calculateSittingServiceValue());


                // Update owned assets display
                displayOwnedStocks();
                displayOwnedRealEstate();
                displayOwnedBusinesses();
                displayOwnedBonds();
                displayOwnedSideGigs();
                displayOwnedStarterBusinesses();
                displayOwnedSittingServices();


                // Update widgets
                updateWidgets();
            }

            function updateWidgets() {
                // Update Key Stats
                document.getElementById('cash-value').textContent = formatNumber(gameState.cash);
                document.getElementById('energy-value').textContent = `${gameState.energy}%`;
                document.getElementById('net-worth-value').textContent = formatNumber(calculateNetWorth());

                // Update Investment Overview
                // Changed to display the number of items owned instead of the total value
                document.getElementById('stocks-overview').textContent = Object.keys(gameState.portfolio.stocks).length; // Count distinct stock types
                document.getElementById('real-estate-overview').textContent = Object.keys(gameState.portfolio.realEstate).length; // Count properties
                document.getElementById('businesses-overview').textContent = Object.keys(gameState.portfolio.businesses).length; // Count businesses
                document.getElementById('bonds-overview').textContent = Object.keys(gameState.portfolio.bonds).length; // Count bonds


                // Update Daily Income
                document.getElementById('business-income').textContent = formatNumber(calculateBusinessIncome());
                document.getElementById('property-income').textContent = formatNumber(calculatePropertyIncome());
                document.getElementById('bond-income').textContent = formatNumber(calculateBondIncome());

                // Update Active Opportunities
                updateActiveOpportunities();
            }

            function updateActiveOpportunities() {
                const opportunitiesList = document.getElementById('active-opportunities-list');
                opportunitiesList.innerHTML = '';

                // Add golden opportunities
                if (gameState.goldenOpportunities && gameState.goldenOpportunities.length > 0) {
                    gameState.goldenOpportunities.forEach((opp, index) => {
                        const div = document.createElement('div');
                        div.className = 'list-item';
                        div.innerHTML = `
                            <div>
                                <strong>${opp.name}</strong><br>
                                ${opp.description}<br>
                                Cost: $${opp.cost.toLocaleString()}
                            </div>
                            <div>
                                <button class="btn" onclick="takeGoldenOpportunity(${index})">Take Opportunity</button>
                            </div>
                        `;
                        opportunitiesList.appendChild(div);
                    });
                }

                // Add daily challenge if active
                if (gameState.dailyChallenge) {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `
                        <div>
                            <strong>Daily Challenge: ${gameState.dailyChallenge.name}</strong><br>
                            ${gameState.dailyChallenge.description}<br>
                            Progress: ${gameState.dailyProgress[gameState.dailyChallenge.requirement.type]}/${gameState.dailyChallenge.requirement.count}
                        </div>
                    `;
                    opportunitiesList.appendChild(div);
                }
            }


            // Modal Functions
            function showModal(modalId, clickedButton) {
                const modal = document.getElementById(modalId);
                const modalContent = document.getElementById('modalContent');
                if (modal) {
                    // Remove active class from all buttons first
                    document.querySelectorAll('.quick-actions .btn').forEach(button => {
                        button.classList.remove('active');
                    });

                    // Add active class to the clicked button
                    if (clickedButton) {
                        clickedButton.classList.add('active');
                    }

                    // Add show class to trigger fade-in and scale-in
                    modal.classList.add('show');

                    // Add class to modal content to trigger staggered animation for its children
                    if (modalContent) {
                        modalContent.classList.add('animate-modal-content');
                         // Use setTimeout to remove the class after animations complete
                         // Adjust timeout based on expected total animation time (e.g., num_items * delay + animation_duration)
                         // For simplicity, a fixed delay is used here. A more robust solution might calculate based on children.
                         setTimeout(() => {
                            modalContent.classList.remove('animate-modal-content');
                        }, 1000); // Example: 1 second delay
                    }

                }
            }

            function closeModal(modalId) {
                const modal = document.getElementById(modalId);
                const modalContent = document.getElementById('modalContent');
                if (modal) {
                    // Remove show class to trigger fade-out and scale-out
                    modal.classList.remove('show');

                    // Remove active class from all buttons
                    document.querySelectorAll('.quick-actions .btn').forEach(button => {
                        button.classList.remove('active');
                    });

                     // Remove animation class from modal content immediately on close
                     if (modalContent) {
                        modalContent.classList.remove('animate-modal-content');
                     }

                     // Hide the modal completely after the transition finishes
                     modal.addEventListener('transitionend', function handler() {
                        if (!modal.classList.contains('show')) {
                             modal.style.display = 'none';
                             modal.removeEventListener('transitionend', handler);
                        }
                     });
                }
            }


            // Screen Functions
            function showHustles(clickedButton) {
                const content = `
                    <h2><i class="fas fa-briefcase"></i> Available Hustles</h2>
                    <div class="hustle-list">
                        <div class="list-item">
                            <strong>Food Delivery Driver</strong> <span class="tier-badge tier-beginner">Beginner</span><br>
                            Earn $15/hour delivering food. Requires 10 energy per hour.
                            <button class="btn" onclick="startHustle('delivery', 15, 10)" style="margin-top: 10px;">Start Hustle</button>
                        </div>
                        <div class="list-item">
                            <strong>Freelance Writing</strong> <span class="tier-badge tier-intermediate">Intermediate</span><br>
                            Earn $25/hour writing content. Requires 15 energy per hour.
                            <button class="btn" onclick="startHustle('writing', 25, 15)" style="margin-top: 10px;">Start Hustle</button>
                        </div>
                        <div class="list-item">
                            <strong>Consulting</strong> <span class="tier-badge tier-advanced">Advanced</span><br>
                            Earn $75/hour providing business advice. Requires 20 energy per hour.
                            <button class="btn" onclick="startHustle('consulting', 75, 20)" style="margin-top: 10px;">Start Hustle</button>
                        </div>
                    </div>
                `;
                document.getElementById('modalContent').innerHTML = content;
                showModal('gameModal', clickedButton);
            }

            function showStockMarket(clickedButton) {
                let content = `
                    <h2><i class="fas fa-chart-line"></i> Stock Market</h2>
                    <div class="stock-list">
                `;

                stocks.forEach((stock, index) => {
                    const changeClass = stock.change > 0 ? 'positive' : stock.change < 0 ? 'negative' : 'neutral';
                    content += `
                        <div class="portfolio-item">
                            <div class="stock-info">
                                <div>
                                    <strong>${stock.name} (${stock.symbol})</strong>
                                    <div class="stock-price">$${stock.price.toFixed(2)}</div>
                                </div>
                                <div class="stock-change ${changeClass}">
                                    ${stock.change > 0 ? '+' : ''}${stock.change.toFixed(2)}%
                                </div>
                            </div>
                            <div class="stock-chart">
                                <canvas id="chart-${stock.symbol}"></canvas>
                            </div>
                            <button class="btn" onclick="buyStock('${stock.symbol}', ${stock.price})" style="margin-top: 10px;">Buy</button>
                        </div>
                    `;
                });

                content += `</div>`;
                document.getElementById('modalContent').innerHTML = content;
                showModal('gameModal', clickedButton);

                stocks.forEach(stock => {
                    createStockChart(`chart-${stock.symbol}`, stock);
                });
            }

            function showRealEstate(clickedButton) {
                const properties = [
                    { name: 'Studio Apartment', price: 150000, income: 50, tier: 'beginner' },
                    { name: 'Family Home', price: 350000, income: 150, tier: 'intermediate' },
                    { name: 'Office Building', price: 1200000, income: 800, tier: 'advanced' }
                ];

                let content = `
                    <h2><i class="fas fa-home"></i> Real Estate Market</h2>
                    <div class="property-list">
                `;

                properties.forEach((property, index) => {
                    content += `
                        <div class="list-item">
                            <strong>${property.name}</strong> <span class="tier-badge tier-${property.tier}">${property.tier}</span><br>
                            Price: $${property.price.toLocaleString()} | Daily Income: $${property.income}
                            <button class="btn" onclick="buyProperty('${property.name}', ${property.price}, ${property.income})" style="margin-top: 10px;">Purchase</button>
                        </div>
                    `;
                });

                content += `</div>`;
                document.getElementById('modalContent').innerHTML = content;
                showModal('gameModal', clickedButton);
            }

            function showBusinesses(clickedButton) {
                const businesses = [
                    { name: 'Coffee Shop', price: 50000, income: 200, tier: 'beginner' },
                    { name: 'Tech Startup', price: 200000, income: 1000, tier: 'intermediate' },
                    { name: 'Manufacturing Plant', price: 2000000, income: 5000, tier: 'advanced' }
                ];

                let content = `
                    <h2><i class="fas fa-building"></i> Business Opportunities</h2>
                    <div class="business-list">
                `;

                businesses.forEach(business => {
                    content += `
                        <div class="list-item">
                            <strong>${business.name}</strong> <span class="tier-badge tier-${business.tier}">${business.tier}</span><br>
                            Investment: $${business.price.toLocaleString()} | Daily Profit: $${business.income}
                            <button class="btn" onclick="buyBusiness('${business.name}', ${business.price}, ${business.income})" style="margin-top: 10px;">Invest</button>
                        </div>
                    `;
                });

                content += `</div>`;
                document.getElementById('modalContent').innerHTML = content;
                showModal('gameModal', clickedButton);
            }

            function showBonds(clickedButton) {
                const bonds = [
                    { name: 'Government Bond', price: 1000, income: 5, duration: 30, tier: 'beginner' },
                    { name: 'Corporate Bond', price: 5000, income: 35, duration: 60, tier: 'intermediate' },
                    { name: 'High-Yield Bond', price: 25000, income: 250, duration: 90, tier: 'advanced' }
                ];

                let content = `
                    <h2><i class="fas fa-file-invoice-dollar"></i> Bond Market</h2>
                    <div class="bond-list">
                `;

                bonds.forEach(bond => {
                    content += `
                        <div class="list-item">
                            <strong>${bond.name}</strong> <span class="tier-badge tier-${bond.tier}">${bond.tier}</span><br>
                            Price: $${bond.price.toLocaleString()} | Daily Return: $${bond.income} | Duration: ${bond.duration} days
                            <button class="btn" onclick="buyBond('${bond.name}', ${bond.price}, ${bond.income})" style="margin-top: 10px;">Purchase</button>
                        </div>
                    `;
                });

                content += `</div>`;
                document.getElementById('modalContent').innerHTML = content;
                showModal('gameModal', clickedButton);
            }

            function showSideGigs(clickedButton) {
                const gigs = [
                    { name: 'Tutoring', rate: 20, tier: 'beginner' },
                    { name: 'Graphic Design', rate: 35, tier: 'intermediate' },
                    { name: 'Web Development', rate: 65, tier: 'advanced' }
                ];

                let content = `
                    <h2><i class="fas fa-tasks"></i> Side Gigs</h2>
                    <div class="gig-list">
                `;

                gigs.forEach(gig => {
                    content += `
                        <div class="list-item">
                            <strong>${gig.name}</strong> <span class="tier-badge tier-${gig.tier}">${gig.tier}</span><br>
                            Hourly Rate: $${gig.rate}
                            <button class="btn" onclick="startSideGig('${gig.name}', ${gig.rate})" style="margin-top: 10px;">Start Gig</button>
                        </div>
                    `;
                });

                content += `</div>`;
                document.getElementById('modalContent').innerHTML = content;
                showModal('gameModal', clickedButton);
            }

            function showStarterBusinesses(clickedButton) {
                const starters = [
                    { name: 'Lemonade Stand', price: 100, income: 15, tier: 'beginner' },
                    { name: 'Car Wash Service', price: 1000, income: 75, tier: 'beginner' },
                    { name: 'Food Truck', price: 15000, income: 200, tier: 'intermediate' }
                ];

                let content = `
                    <h2><i class="fas fa-store"></i> Starter Businesses</h2>
                    <div class="starter-list">
                `;

                starters.forEach(starter => {
                    content += `
                        <div class="list-item">
                            <strong>${starter.name}</strong> <span class="tier-badge tier-${starter.tier}">${starter.tier}</span><br>
                            Cost: $${starter.price.toLocaleString()} | Daily Profit: $${starter.income}
                            <button class="btn" onclick="buyStarterBusiness('${starter.name}', ${starter.price}, ${starter.income})" style="margin-top: 10px;">Start</button>
                        </div>
                    `;
                });

                content += `</div>`;
                document.getElementById('modalContent').innerHTML = content;
                showModal('gameModal', clickedButton);
            }

            function showSittingServices(clickedButton) {
                const services = [
                    { name: 'Pet Sitting', rate: 25, tier: 'beginner' },
                    { name: 'House Sitting', rate: 40, tier: 'intermediate' },
                    { name: 'Baby Sitting', rate: 15, tier: 'beginner' }
                ];

                let content = `
                    <h2><i class="fas fa-paw"></i> Sitting Services</h2>
                    <div class="sitting-list">
                `;

                services.forEach(service => {
                    content += `
                        <div class="list-item">
                            <strong>${service.name}</strong> <span class="tier-badge tier-${service.tier}">${service.tier}</span><br>
                            Daily Rate: $${service.rate}
                            <button class="btn" onclick="startSittingService('${service.name}', ${service.rate})" style="margin-top: 10px;">Offer Service</button>
                        </div>
                    `;
                });

                content += `</div>`;
                document.getElementById('modalContent').innerHTML = content;
                showModal('gameModal', clickedButton);
            }

            function showCryptoFaucets(clickedButton) {
                const faucets = [
                    { name: 'Bitcoin Faucet', reward: 0.00001, currency: 'BTC', tier: 'beginner' },
                    { name: 'Ethereum Tasks', reward: 0.001, currency: 'ETH', tier: 'intermediate' },
                    { name: 'DeFi Rewards', reward: 10, currency: 'TOKENS', tier: 'advanced' }
                ];

                let content = `
                    <h2><i class="fas fa-coins"></i> Crypto Faucets</h2>
                    <p>Earn small amounts of cryptocurrency by completing simple tasks!</p>
                    <div class="faucet-list">
                `;

                faucets.forEach(faucet => {
                    content += `
                        <div class="list-item">
                            <strong>${faucet.name}</strong> <span class="tier-badge tier-${faucet.tier}">${faucet.tier}</span><br>
                            Reward: ${faucet.reward} ${faucet.currency} per claim
                            <button class="btn" onclick="claimFaucet('${faucet.name}', ${faucet.reward}, '${faucet.currency}')" style="margin-top: 10px;">Claim</button>
                        </div>
                    `;
                });

                content += `</div>`;
                document.getElementById('modalContent').innerHTML = content;
                showModal('gameModal', clickedButton);
            }

            function showMentors(clickedButton) {
                let content = `
                    <h2><i class="fas fa-user-tie"></i> Available Mentors</h2>
                    <div class="mentor-list">
                `;

                Object.entries(mentors).forEach(([id, mentor]) => {
                    content += `
                        <div class="list-item">
                            <strong>${mentor.name}</strong><br>
                            Gift Chance: ${(mentor.giftChance * 100).toFixed(0)}%<br>
                            Gift Range: $${mentor.giftRange.min.toLocaleString()} - $${mentor.giftRange.max.toLocaleString()}
                            <button class="btn" onclick="hireMentor('${mentor.name}', ${mentor.giftRange.min}, 'Gift Chance: ${(mentor.giftChance * 100).toFixed(0)}%')" style="margin-top: 10px;">Hire Mentor</button>
                        </div>
                    `;
                });

                content += `</div>`;
                document.getElementById('modalContent').innerHTML = content;
                showModal('gameModal', clickedButton);
            }

            function showAchievements(clickedButton) {
                let content = `
                    <h2><i class="fas fa-trophy"></i> Achievements</h2>
                    <div class="achievement-list">
                `;

                Object.entries(achievements).forEach(([id, achievement]) => {
                    const status = achievement.completed ? '' : '';
                    const statusClass = achievement.completed ? 'completed' : 'pending';
                    content += `
                        <div class="list-item ${statusClass}">
                            ${status} <strong>${achievement.name}</strong><br>
                            ${achievement.description}
                        </div>
                    `;
                });

                content += `</div>`;
                document.getElementById('modalContent').innerHTML = content;
                showModal('gameModal', clickedButton);
            }

            function showDailyChallenges(clickedButton) {
                const todayChallenge = dailyChallenges[gameState.day % dailyChallenges.length];

                const content = `
                    <h2><i class="fas fa-calendar-check"></i> Daily Challenge</h2>
                    <div class="challenge-container">
                        <div class="list-item">
                            <strong>Today's Challenge:</strong><br>
                            ${todayChallenge.name}<br>
                            ${todayChallenge.description}
                            <br><br>
                            <strong>Reward:</strong> $${todayChallenge.reward.toLocaleString()}
                            <br><br>
                            <strong>Progress:</strong> ${gameState.dailyProgress[todayChallenge.requirement.type]}/${todayChallenge.requirement.count}
                        </div>
                    </div>
                `;
                document.getElementById('modalContent').innerHTML = content;
                showModal('gameModal', clickedButton);
            }

            function showTutorial() {
                showModal('tutorialModal'); // Tutorial modal doesn't need a button highlight
            }


            // Widget Functions
            function toggleWidget(widgetId) {
                const widget = document.getElementById(widgetId);
                const content = widget.querySelector('.widget-content');
                const icon = widget.querySelector('.fa-chevron-up, .fa-chevron-down');

                if (content.classList.contains('collapsed')) {
                    content.classList.remove('collapsed');
                    if (icon) icon.className = 'fas fa-chevron-up';
                } else {
                    content.classList.add('collapsed');
                    if (icon) icon.className = 'fas fa-chevron-down';
                }
            }

            function showWidgetSettings(widgetId) {
                alert(`Settings for ${widgetId} - Feature coming soon!`);
            }

            // Generate realistic stock price history
            function generateStockHistory(initialPrice, volatility, trend) {
                const history = [];
                let price = initialPrice;
                const days = 30; // 30 days of history

                for (let i = 0; i < days; i++) {
                    // Random walk with drift and trend
                    const randomFactor = (Math.random() - 0.5) * volatility;
                    const trendFactor = trend * (i / days); // Gradually apply trend
                    const change = price * (randomFactor + trendFactor);

                    // Ensure price doesn't deviate too far from base price
                    const maxDeviation = initialPrice * 0.3; // Max 30% deviation
                    price = Math.max(
                        Math.min(price + change, initialPrice + maxDeviation),
                        initialPrice - maxDeviation
                    );

                    history.push({ 
                        date: new Date(Date.now() - (days - i) * 24 * 60 * 60 * 1000),
                        price: price
                    });
                }

                return history;
            }

            // Initialize stock histories
            function initializeStockHistories() {
                stocks.forEach(stock => {
                    stock.history = generateStockHistory(stock.basePrice, stock.volatility, stock.trend);
                });
            }

            // Update stock prices realistically
            function updateStockPrices() {
                const now = Date.now();
                const assumedIntervalSeconds = 60; // Assuming the setInterval runs every 60 seconds

                stocks.forEach(stock => {
                    const oldPrice = stock.price; // Store the price before the update

                    // Calculate time-based change
                    const timeFactor = assumedIntervalSeconds / (24 * 60 * 60); // Convert 1 minute to fraction of a day
                    const trendChange = stock.basePrice * stock.trend * timeFactor;

                    // Add some random movement
                    const randomChange = stock.basePrice * stock.volatility * (Math.random() - 0.5) * 0.1;

                    // Calculate new price
                    const newPrice = oldPrice + trendChange + randomChange; // Calculate from oldPrice

                    // Ensure price stays within reasonable bounds
                    const maxDeviation = stock.basePrice * 0.3;
                    stock.price = Math.max(
                        Math.min(newPrice, stock.basePrice + maxDeviation),
                        stock.basePrice - maxDeviation
                    );

                    // Update change percentage based on the difference from the old price
                    stock.change = ((stock.price - oldPrice) / oldPrice) * 100;
                    if (oldPrice === 0) stock.change = 0; // Avoid division by zero if price was 0

                    // Update history
                    stock.history.push({ 
                        date: new Date(),
                        price: stock.price
                    });

                    // Keep only last 30 days of history
                    if (stock.history.length > 30) {
                        stock.history.shift();
                    }

                    stock.lastUpdate = now;
                });
            }

            // Create stock chart
            function createStockChart(canvasId, stock) {
                const ctx = document.getElementById(canvasId);
                if (!ctx) {
                    return null; // Return null if canvas is not found
                }

                const context = ctx.getContext('2d');
                const gradient = context.createLinearGradient(0, 0, 0, 200);
                gradient.addColorStop(0, 'rgba(108, 99, 255, 0.2)');
                gradient.addColorStop(1, 'rgba(108, 99, 255, 0)');

                // Destroy existing chart instance if it exists
                if (ctx.chart) {
                    ctx.chart.destroy();
                }

                const chart = new Chart(context, {
                    type: 'line',
                    data: {
                        labels: stock.history.map(h => h.date.toLocaleDateString()),
                        datasets: [{
                            label: stock.symbol,
                            data: stock.history.map(h => h.price),
                            borderColor: 'rgb(108, 99, 255)',
                            backgroundColor: gradient,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        return `$${context.parsed.y.toFixed(2)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                display: false
                            },
                            y: {
                                display: false,
                                min: Math.min(...stock.history.map(h => h.price)) * 0.95,
                                max: Math.max(...stock.history.map(h => h.price)) * 1.05
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        // Add animation options
                        animation: {
                            duration: 800, // Animation duration in milliseconds
                            easing: 'easeOutQuart' // Easing function
                        }
                    }
                });

                // Store chart instance on the canvas element
                ctx.chart = chart;

                return chart;
            }

            // Initialize the game when page loads
            document.addEventListener('DOMContentLoaded', function() {
                loadGameState(); // Load saved game state
                initializeStockHistories(); // Initialize stock histories for all stocks

                // Assign the daily challenge based on the current game day
                gameState.dailyChallenge = dailyChallenges[gameState.day % dailyChallenges.length];

                // Energy Regeneration: Gain 5 energy every 5 seconds
                setInterval(() => {
                    if (gameState.energy < 100) {
                        gameState.energy = Math.min(gameState.energy + 5, 100); // Add energy, cap at 100
                        updateUI(); // Update UI to show new energy
                    }
                }, 5000); // 5000 milliseconds = 5 seconds


                setInterval(() => {
                    try {
                        updateStockPrices();
                    } catch (error) {
                    }

                    if (document.getElementById('gameModal').style.display === 'block') {
                        showStockMarket(); // Only refresh if market is open
                    }
                    updateUI();
                    saveGameState(); // Save periodically
                }, 60000); // Update every minute

                setTimeout(() => {
                    try {
                        updateStockPrices();
                         if (document.getElementById('gameModal').style.display === 'block') {
                            showStockMarket();
                        }
                         updateUI(); // Update other UI elements after initial stock price update
                         saveGameState(); // Save after initial update
                    } catch (error) {
                    }
                }, 1000); // 1 second delay

                updateUI();
            });

            // Close modal when clicking outside
            window.onclick = function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                }
            }

            // Konami Code Implementation
            const konamiCode = [
                'ArrowUp', 'ArrowUp',
                'ArrowDown', 'ArrowDown',
                'ArrowLeft', 'ArrowRight',
                'ArrowLeft', 'ArrowRight',
                'KeyB', 'KeyA'
            ];
            let konamiCodePosition = 0;

            document.addEventListener('keydown', (e) => {
                // Check if the key pressed matches the next key in the sequence
                if (e.code === konamiCode[konamiCodePosition]) {
                    konamiCodePosition++;

                    // If the entire sequence has been entered
                    if (konamiCodePosition === konamiCode.length) {
                        activateKonamiBonus();
                        konamiCodePosition = 0; // Reset position
                    }
                } else {
                    konamiCodePosition = 0; // Reset position if the wrong key is pressed
                }
            });

            function activateKonamiBonus() {
                // Example bonus: Add a large amount of cash and energy
                gameState.cash += 100000;
                gameState.energy = 100; // Restore full energy
                updateUI();
                saveGameState();
                alert('Konami Code Activated! You received a bonus!');
            }

            // Add a cash in button thats gives money for the investments or bond or whatever u bought
            function cashInStock(symbol) {
                if (gameState.portfolio.stocks[symbol] && gameState.portfolio.stocks[symbol] > 0) {
                    const stock = stocks.find(s => s.symbol === symbol);
                    if (stock) {
                        // Calculate potential loss/gain based on current price
                        const currentValue = stock.price;
                        const originalValue = stock.originalPrice || stock.price; // Use original price if available
                        const difference = currentValue - originalValue;
                        
                        gameState.cash += currentValue; // Sell at current price
                        gameState.portfolio.stocks[symbol]--;
                        if (gameState.portfolio.stocks[symbol] === 0) {
                            delete gameState.portfolio.stocks[symbol];
                        }
                        updateUI();
                        saveGameState();
                        
                        if (difference < 0) {
                            alert(`Sold 1 share of ${symbol} for $${currentValue.toFixed(2)}! You lost $${Math.abs(difference).toFixed(2)} on this trade.`);
                        } else if (difference > 0) {
                            alert(`Sold 1 share of ${symbol} for $${currentValue.toFixed(2)}! You made $${difference.toFixed(2)} on this trade.`);
                        } else {
                            alert(`Sold 1 share of ${symbol} for $${currentValue.toFixed(2)}! No profit or loss on this trade.`);
                        }
                    }
                } else {
                    alert('You don\'t own any shares of this stock!');
                }
            }

            function cashInAllStocks(symbol) {
                if (gameState.portfolio.stocks[symbol] && gameState.portfolio.stocks[symbol] > 0) {
                    const stock = stocks.find(s => s.symbol === symbol);
                    if (stock) {
                        const shares = gameState.portfolio.stocks[symbol];
                        const currentValue = stock.price * shares;
                        const originalValue = (stock.originalPrice || stock.price) * shares;
                        const difference = currentValue - originalValue;
                        
                        gameState.cash += currentValue;
                        delete gameState.portfolio.stocks[symbol];
                        updateUI();
                        saveGameState();
                        
                        if (difference < 0) {
                            alert(`Cashed in all ${shares} shares of ${symbol} for $${currentValue.toFixed(2)}! You lost $${Math.abs(difference).toFixed(2)} on this trade.`);
                        } else if (difference > 0) {
                            alert(`Cashed in all ${shares} shares of ${symbol} for $${currentValue.toFixed(2)}! You made $${difference.toFixed(2)} on this trade.`);
                        } else {
                            alert(`Cashed in all ${shares} shares of ${symbol} for $${currentValue.toFixed(2)}! No profit or loss on this trade.`);
                        }
                    }
                } else {
                    alert('You don\'t own any shares of this stock to cash in!');
                }
            }

            function cashInProperty(name) {
                if (gameState.portfolio.realEstate[name]) {
                    const property = gameState.portfolio.realEstate[name];
                    // Add market fluctuation to property value
                    const marketFluctuation = (Math.random() * 0.4) - 0.2; // Random value between -20% and +20%
                    const currentValue = Math.round(property.value * (1 + marketFluctuation));
                    const difference = currentValue - property.value;
                    
                    gameState.cash += currentValue;
                    delete gameState.portfolio.realEstate[name];
                    updateUI();
                    saveGameState();
                    
                    if (difference < 0) {
                        alert(`Sold ${name} for $${currentValue.toLocaleString()}! You lost $${Math.abs(difference).toLocaleString()} on this investment.`);
                    } else if (difference > 0) {
                        alert(`Sold ${name} for $${currentValue.toLocaleString()}! You made $${difference.toLocaleString()} on this investment.`);
                    } else {
                        alert(`Sold ${name} for $${currentValue.toLocaleString()}! No profit or loss on this investment.`);
                    }
                } else {
                    alert('You don\'t own this property!');
                }
            }

            function cashInBusiness(name) {
                if (gameState.portfolio.businesses[name]) {
                    const business = gameState.portfolio.businesses[name];
                    // Add market fluctuation to business value
                    const marketFluctuation = (Math.random() * 0.4) - 0.2; // Random value between -20% and +20%
                    const currentValue = Math.round(business.value * (1 + marketFluctuation));
                    const difference = currentValue - business.value;
                    
                    gameState.cash += currentValue;
                    delete gameState.portfolio.businesses[name];
                    updateUI();
                    saveGameState();
                    
                    if (difference < 0) {
                        alert(`Sold ${name} for $${currentValue.toLocaleString()}! You lost $${Math.abs(difference).toLocaleString()} on this investment.`);
                    } else if (difference > 0) {
                        alert(`Sold ${name} for $${currentValue.toLocaleString()}! You made $${difference.toLocaleString()} on this investment.`);
                    } else {
                        alert(`Sold ${name} for $${currentValue.toLocaleString()}! No profit or loss on this investment.`);
                    }
                } else {
                    alert('You don\'t own this business!');
                }
            }

            function cashInBond(name) {
                if (gameState.portfolio.bonds[name]) {
                    const bond = gameState.portfolio.bonds[name];
                    // Add small market fluctuation to bond value (bonds are more stable)
                    const marketFluctuation = (Math.random() * 0.2) - 0.1; // Random value between -10% and +10%
                    const currentValue = Math.round(bond.value * (1 + marketFluctuation));
                    const difference = currentValue - bond.value;
                    
                    gameState.cash += currentValue;
                    delete gameState.portfolio.bonds[name];
                    updateUI();
                    saveGameState();
                    
                    if (difference < 0) {
                        alert(`Sold ${name} bond for $${currentValue.toLocaleString()}! You lost $${Math.abs(difference).toLocaleString()} on this investment.`);
                    } else if (difference > 0) {
                        alert(`Sold ${name} bond for $${currentValue.toLocaleString()}! You made $${difference.toLocaleString()} on this investment.`);
                    } else {
                        alert(`Sold ${name} bond for $${currentValue.toLocaleString()}! No profit or loss on this investment.`);
                    }
                } else {
                    alert('You don\'t own this bond!');
                }
            }

            function cashInSideGig(name) {
                 if (gameState.portfolio.sideGigs[name]) {
                    const gig = gameState.portfolio.sideGigs[name];
                     // Determine a cash-in value for side gigs (e.g., based on hourly rate or a fixed amount)
                     const cashInValue = gig.hourlyRate * 40; // Example: 40 hours worth of pay
                    gameState.cash += cashInValue;
                    delete gameState.portfolio.sideGigs[name];
                    updateUI();
                    saveGameState();
                    alert(`Cashed in ${name} side gig for $${cashInValue.toLocaleString()}!`);
                }
            }

            function cashInStarterBusiness(name) {
                 if (gameState.portfolio.starterBusinesses[name]) {
                    const business = gameState.portfolio.starterBusinesses[name];
                    gameState.cash += business.value; // Sell at investment value
                    delete gameState.portfolio.starterBusinesses[name];
                    updateUI();
                    saveGameState();
                    alert(`Cashed in ${name} for $${business.value.toLocaleString()}!`);
                }
            }

            function cashInSittingService(name) {
                 if (gameState.portfolio.sittingServices[name]) {
                    const service = gameState.portfolio.sittingServices[name];
                     // Determine a cash-in value for sitting services (e.g., based on daily rate or a fixed amount)
                     const cashInValue = service.dailyRate * 7; // Example: 7 days worth of pay
                    gameState.cash += cashInValue;
                    delete gameState.portfolio.sittingServices[name];
                    updateUI();
                    saveGameState();
                    alert(`Cashed in ${name} service for $${cashInValue.toLocaleString()}!`);
                }
            }

            // Add new cash in income functions
            function cashInPropertyIncome(name) {
                if (gameState.portfolio.realEstate[name]) {
                    const property = gameState.portfolio.realEstate[name];
                    const income = property.dailyIncome * 7; // Cash in 7 days of income
                    gameState.cash += income;
                    updateUI();
                    saveGameState();
                    alert(`Cashed in 7 days of income from ${name} for $${income.toLocaleString()}!`);
                }
            }

            function cashInBusinessIncome(name) {
                if (gameState.portfolio.businesses[name]) {
                    const business = gameState.portfolio.businesses[name];
                    const income = business.dailyIncome * 7; // Cash in 7 days of income
                    gameState.cash += income;
                    updateUI();
                    saveGameState();
                    alert(`Cashed in 7 days of income from ${name} for $${income.toLocaleString()}!`);
                }
            }

            function cashInBondIncome(name) {
                if (gameState.portfolio.bonds[name]) {
                    const bond = gameState.portfolio.bonds[name];
                    const income = bond.dailyIncome * 7; // Cash in 7 days of income
                    gameState.cash += income;
                    updateUI();
                    saveGameState();
                    alert(`Cashed in 7 days of income from ${name} for $${income.toLocaleString()}!`);
                }
            }


            // Functions to display owned assets
            function displayOwnedStocks() {
                const stockDetailsDiv = document.getElementById('stockDetails');
                stockDetailsDiv.innerHTML = ''; // Clear previous content

                const ownedStocks = Object.entries(gameState.portfolio.stocks);

                if (ownedStocks.length === 0) {
                    stockDetailsDiv.innerHTML = '<p>No stocks owned.</p>';
                    return;
                }

                ownedStocks.forEach(([symbol, shares]) => {
                    const stock = stocks.find(s => s.symbol === symbol);
                    if (stock) {
                        const div = document.createElement('div');
                        div.className = 'portfolio-item owned-asset-item';
                        div.innerHTML = `
                            <div class="stock-info">
                                <div>
                                    <strong>${stock.name} (${stock.symbol})</strong> - ${shares} shares<br>
                                    Current Value: $${(stock.price * shares).toFixed(2)}
                                </div>
                                <div>
                                    <button class="btn cash-in-btn" onclick="cashInStock('${stock.symbol}')">Sell 1 Share</button>
                                    <button class="btn cash-in-btn" onclick="cashInAllStocks('${stock.symbol}')" style="margin-left: 10px;">Cash In All</button>
                                </div>
                            </div>
                        `;
                        stockDetailsDiv.appendChild(div);
                    }
                });
            }

            function displayOwnedRealEstate() {
                const realEstateDetailsDiv = document.getElementById('realEstateDetails');
                realEstateDetailsDiv.innerHTML = '';

                const ownedProperties = Object.entries(gameState.portfolio.realEstate);

                if (ownedProperties.length === 0) {
                    realEstateDetailsDiv.innerHTML = '<p>No properties owned.</p>';
                    return;
                }

                ownedProperties.forEach(([name, property]) => {
                    const div = document.createElement('div');
                    div.className = 'list-item portfolio-item owned-asset-item';
                    div.innerHTML = `
                        <div>
                            <strong>${name}</strong><br>
                            Purchase Value: $${property.value.toLocaleString()} | Daily Income: $${property.dailyIncome.toLocaleString()}
                        </div>
                        <div>
                            <button class="btn cash-in-btn" onclick="cashInProperty('${name}')">Sell</button>
                            <button class="btn cash-in-btn" onclick="cashInPropertyIncome('${name}')" style="margin-left: 10px;">Cash In Income</button>
                        </div>
                    `;
                    realEstateDetailsDiv.appendChild(div);
                });
            }

            function displayOwnedBusinesses() {
                const businessDetailsDiv = document.getElementById('businessDetails');
                businessDetailsDiv.innerHTML = '';

                const ownedBusinesses = Object.entries(gameState.portfolio.businesses);

                if (ownedBusinesses.length === 0) {
                    businessDetailsDiv.innerHTML = '<p>No businesses owned.</p>';
                    return;
                }

                ownedBusinesses.forEach(([name, business]) => {
                    const div = document.createElement('div');
                    div.className = 'list-item portfolio-item owned-asset-item';
                    div.innerHTML = `
                        <div>
                            <strong>${name}</strong><br>
                            Investment: $${business.value.toLocaleString()} | Daily Profit: $${business.dailyIncome.toLocaleString()}
                        </div>
                        <div>
                            <button class="btn cash-in-btn" onclick="cashInBusiness('${name}')">Sell</button>
                            <button class="btn cash-in-btn" onclick="cashInBusinessIncome('${name}')" style="margin-left: 10px;">Cash In Income</button>
                        </div>
                    `;
                    businessDetailsDiv.appendChild(div);
                });
            }

            function displayOwnedBonds() {
                const bondDetailsDiv = document.getElementById('bondDetails');
                bondDetailsDiv.innerHTML = '';

                const ownedBonds = Object.entries(gameState.portfolio.bonds);

                if (ownedBonds.length === 0) {
                    bondDetailsDiv.innerHTML = '<p>No bonds owned.</p>';
                    return;
                }

                ownedBonds.forEach(([name, bond]) => {
                    const div = document.createElement('div');
                    div.className = 'list-item portfolio-item owned-asset-item';
                    div.innerHTML = `
                        <div>
                            <strong>${name}</strong><br>
                            Purchase Price: $${bond.value.toLocaleString()} | Daily Return: $${bond.dailyIncome.toLocaleString()} | Duration: ${bond.duration} days
                        </div>
                        <div>
                            <button class="btn cash-in-btn" onclick="cashInBond('${name}')">Sell</button>
                            <button class="btn cash-in-btn" onclick="cashInBondIncome('${name}')" style="margin-left: 10px;">Cash In Income</button>
                        </div>
                    `;
                    bondDetailsDiv.appendChild(div);
                });
            }


            function displayOwnedSideGigs() {
                const sideGigDetailsDiv = document.getElementById('sideGigDetails');
                sideGigDetailsDiv.innerHTML = '';

                const ownedGigs = Object.entries(gameState.portfolio.sideGigs);

                if (ownedGigs.length === 0) {
                    sideGigDetailsDiv.innerHTML = '<p>No side gigs active.</p>';
                    return;
                }

                ownedGigs.forEach(([name, gig]) => {
                    const div = document.createElement('div');
                    div.className = 'list-item portfolio-item owned-asset-item';
                    div.innerHTML = `
                        <div>
                            <strong>${name}</strong><br>
                            Hourly Rate: $${gig.hourlyRate}
                        </div>
                        <button class="btn cash-in-btn" onclick="cashInSideGig('${name}')">Sell</button>
                    `;
                    sideGigDetailsDiv.appendChild(div);
                });
            }


            function displayOwnedStarterBusinesses() {
                const starterBusinessDetailsDiv = document.getElementById('starterBusinessDetails');
                starterBusinessDetailsDiv.innerHTML = '';

                const ownedStarters = Object.entries(gameState.portfolio.starterBusinesses);

                if (ownedStarters.length === 0) {
                    starterBusinessDetailsDiv.innerHTML = '<p>No starter businesses owned.</p>';
                    return;
                }

                ownedStarters.forEach(([name, business]) => {
                     const div = document.createElement('div');
                    div.className = 'list-item portfolio-item owned-asset-item';
                    div.innerHTML = `
                        <div>
                            <strong>${name}</strong><br>
                            Investment: $${business.value.toLocaleString()} | Daily Profit: $${business.dailyIncome.toLocaleString()}
                        </div>
                        <button class="btn cash-in-btn" onclick="cashInStarterBusiness('${name}')">Sell</button>
                    `;
                    starterBusinessDetailsDiv.appendChild(div);
                });
            }

            function displayOwnedSittingServices() {
                const sittingServiceDetailsDiv = document.getElementById('sittingServiceDetails');
                sittingServiceDetailsDiv.innerHTML = '';

                const ownedServices = Object.entries(gameState.portfolio.sittingServices);

                if (ownedServices.length === 0) {
                    sittingServiceDetailsDiv.innerHTML = '<p>No sitting services active.</p>';
                    return;
                }

                ownedServices.forEach(([name, service]) => {
                    const div = document.createElement('div');
                    div.className = 'list-item portfolio-item owned-asset-item';
                    div.innerHTML = `
                        <div>
                            <strong>${name}</strong><br>
                            Daily Rate: $${service.dailyRate}
                        </div>
                        <button class="btn cash-in-btn" onclick="cashInSittingService('${name}')">Sell</button>
                    `;
                    sittingServiceDetailsDiv.appendChild(div);
                });
            }


            // Scroll to Top Button
            document.getElementById('scrollToTopBtn').addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            // Show/hide scroll to top button based on scroll position
            window.addEventListener('scroll', () => {
                if (window.scrollY > 200) {
                    document.getElementById('scrollToTopBtn').style.display = 'block';
                } else {
                    document.getElementById('scrollToTopBtn').style.display = 'none';
                }
            });

            // Add event listeners to quick action buttons to pass 'this' (the button element)
            document.querySelectorAll('.quick-actions .btn').forEach(button => {
                const originalOnClick = button.onclick;
                if (originalOnClick) { // Check if onclick is defined
                    button.onclick = function() {
                        // Call the original onclick function, passing the button element
                        originalOnClick.call(this, this);
                    };
                }
            });
        </script>

        <!-- Scroll to Top Button -->
        <button id="scrollToTopBtn" class="btn" title="Go to top"><i class="fas fa-arrow-up"></i></button>

        <!--  Settings Panel HTML -->
        <button id="settingsToggle"></button>
        <div id="settingsPanel" style="display: none;">
          <h2>Settings</h2>
          <label><input type="checkbox" id="darkModeToggle"> Dark Mode</label><br>
          <label><input type="checkbox" id="autoCollectToggle"> Auto Collect Income</label><br>
          <label>Volume: <input type="range" id="volumeSlider" min="0" max="100" value="100"></label><br>
          <button id="resetGameBtn">Reset Game</button>
        </div>

        <!--  Settings Panel CSS -->
        <style>
        #settingsToggle {
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 10px 15px;
          border: none;
          border-radius: 50%;
          background-color: var(--primary-color);
          color: white;
          font-size: 18px;
          cursor: pointer;
          z-index: 9999;
        }

        #settingsPanel {
          position: fixed;
          top: 70px;
          right: 20px;
          background: rgba(0, 0, 0, 0.85);
          padding: 15px;
          border-radius: 10px;
          color: white;
          z-index: 9999;
          font-family: 'Poppins', sans-serif;
        }
        #settingsPanel label, #settingsPanel button {
          margin-top: 10px;
          display: block;
        }
        </style>

        <!--  Settings Panel JS -->
        <script>
        const settingsPanel = document.getElementById("settingsPanel");
        document.getElementById("settingsToggle").onclick = () => {
          settingsPanel.style.display = (settingsPanel.style.display === 'none') ? 'block' : 'none';
        };

        window.addEventListener("load", () => {
          document.getElementById('darkModeToggle').checked = localStorage.getItem('darkMode') === 'true';
          document.getElementById('autoCollectToggle').checked = localStorage.getItem('autoCollect') === 'true';
          document.getElementById('volumeSlider').value = localStorage.getItem('volume') || 100;
          applySettings();
        });

        document.getElementById("darkModeToggle").onchange = (e) => {
          localStorage.setItem('darkMode', e.target.checked);
          applySettings();
        };
        document.getElementById("autoCollectToggle").onchange = (e) => {
          localStorage.setItem('autoCollect', e.target.checked);
        };
        document.getElementById("volumeSlider").oninput = (e) => {
          localStorage.setItem('volume', e.target.value);
        };
        document.getElementById("resetGameBtn").onclick = () => {
          if (confirm("Reset all game progress?")) {
            localStorage.clear();
            location.reload();
          }
        };
        function applySettings() {
          const dark = document.getElementById('darkModeToggle').checked;
          document.body.style.backgroundColor = dark ? '#121212' : 'var(--background-color)';
          document.body.style.color = dark ? '#fff' : 'var(--text-color)';
        }
        </script>

    </div> <!-- Close mainContainer -->
</body>
</html>
